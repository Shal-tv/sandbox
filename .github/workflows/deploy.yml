name: CI/CD

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: debian-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v2

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v1

            -   name: Build Docker image
                run: |
                    docker build -t sandbox:latest .

            -   name: Copy Docker image to server
                run: |
                    scp -o StrictHostKeyChecking=no -i ${{ secrets.SERVER_SSH_KEY }} ./sandbox.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/${{ secrets.SERVER_USER }}/

            -   name: SSH and deploy
                uses: appleboy/ssh-action@v0.1.5
                with:
                    host: ${{ secrets.SERVER_HOST }}
                    username: ${{ secrets.SERVER_USER }}
                    key: ${{ secrets.SERVER_SSH_KEY }}
                    script: |
                        docker load -i /home/${{ secrets.SERVER_USER }}/sandbox.tar.gz
                        docker-compose -f /path/to/docker-compose.yml up -d
